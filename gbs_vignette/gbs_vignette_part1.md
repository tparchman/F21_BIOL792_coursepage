# GBS vignette part 1

## Background
During this tutorial, you will work with an Illumina sequencing dataset that was generated by Josh and Tom to ask questions about the population genetic structure of desert bighorn sheep populations in Nevada. Bighorn sheep used to occupy most of Nevada’s mountain ranges; however, most populations were extirpated throughout the late 1800’s and early 1900’s due to unregulated hunting and disease transmitted from domestic sheep and goats. Over the past 50 years, the Nevada Department of Wildlife translocated thousands of bighorn sheep from the few populations that survived declines into previously occupied habitat to restore Nevada’s bighorn sheep populations. Most individuals came from four different source populations, three found in the Mojave Desert (Muddy Mtns., hunt unit 268; River Mtns., unit 269; Mormon Mtns., unit 271) and one found in the Great Basin Desert (Lone Mountain; unit 212). Almost all of the translocations occurred before genetic information on the source populations was available. During this tutorial, you will analyze ddRADseq data for individuals from the four source populations to determine if any of the source populations are genetically differentiated from one another. ddRADseq is a type of next generation sequencing that uses restriction enzymes to target sequencing of short (100 base pair) DNA fragments throughout the genome and to simultaneously genotype single-nucleotide polymorphisms (SNPs) in large numbers of individuals. During this exercise, you will accomplish the following tasks:

## Objectives
- Become familiar accessing and working on higher power remote computing resources. This includes learning and understanding the following UNIX commands: `ssh`, `rsync`, `top`, `kill`, `ps` `aux`, `bg`
- Become familiar with several file formats commonly encountered when working with high-throughput sequencing data (`fastq`, `fasta`, `sam`, `vcf`)
- Learn how to locate and access genome assemblies and become familiar with what is actually in a genome
- Perform reference-based assembly of DNA sequences to a genome using `bwa`
- Perform variant calling using `samtools` and `bcftools`
- Perform quality filtering using `vcftools`
- Perform initial population genetic analyses using `R`

## Accessing the server

See ssh instructions from TLP.

## Downloading and describing the reference genome

The [NCBI website](https://www.ncbi.nlm.nih.gov) is an online depository that stores most publicly available DNA sequence data, including assembled and annotated genomes. NCBI is free to use and the data can be downloaded by anyone. Today, we will all download the bighorn sheep genome from the NCBI genome domain. The NCBI [Genomes Download FAQ page](https://www.ncbi.nlm.nih.gov/genome/doc/ftpfaq/) is a useful resource for using NCBI to download genomes. First, let’s explore the diversity of organisms with genomes available on NCBI that you might choose to download.

FTP stands for File Transfer Protocol and is one commonly used way to transfer large data files from a computer server to another place, like our laptops. You can definitely use the NCBI Genomes FTP site to download genomes from NCBI, but we’re not going to do that today. Instead, we are going to only use the FTP site to explore how genomes are organized on the website. You can access the FTP site from this [link](ftp://ftp.ncbi.nlm.nih.gov/genomes/). We will be connecting as Guests, and the NCBI genomes directory will pop up (sometimes this takes a few minutes to populate). This directory will be filled with many more directories each containing the genome (or genomes) of several organisms. In all of the directories, including the main one, there will be a file called README.txt that provides a lot of really important information. Additionally, there will be a directory called `all` that holds all of the other genomes, but in a more mysterious format. 

Let’s use the [bighorn sheep genome](https://www.ncbi.nlm.nih.gov/genome/10514?genome_assembly_id=233296) as an example to understand how the `all` directory is organized and how to find this particular genome. Under the Summary part of the page, you will see a lot of important information that summarizes important aspects of the genome, but they can occasionally have errors (we’ll learn how to check this later). To navigate the FTP site, you will need the accession for the genome assembly, which is `GCA_001039535.1` for bighorn sheep. The first three letters are always either `GCA` or `GCF` and correspond to either a GenBank or a RefSeq assembly. In the FTP `all` directory, you’ll see that there are two directories, `GCA` and `GCF`, and our accession tells us that the bighorn sheep genome lives in the `GCA` directory. Inside the `GCA` directory, you’ll see several directories that all are a series of three numbers. The first three numbers of the accession tell you which directory to enter, which is `001` for bighorn sheep. The next three numbers tell you to then enter the `039` directory, and then finally enter the `535` directory (again, the directories can be slow to populate). Inside `535`, you’ll see one last directory that is named with the full genome assembly accession, which is where the genome lives. So what are all of these files? Well, every genome will be  different, but the most important files will be the actual sequence FASTA file (usually labeled `.fa`, `.fna`, or `.fasta`) and the annotation file (`.gff`) if it exists. These files are sometimes gigantic so many will be zipped and have `.gz` at the end.

Do some exploring on your own to find some more genomes in the FTP site. Try to find at least one genome in `GCA` and one in `GCF`. Which files are always found in every genome? How do the different genome directories differ? 

For our data, we are going to use the bighorn sheep genome `fasta` for reference-based alignment of our sequencing data. We could use the FTP site to download the genome, but there is another way that is much faster: the UNIX command rsync. First, we need to make a directory that the genome will live in. In your guest directory on Tom’s server, create a directory called /bighorn_genome. An `rsync` command that will do this correctly:

      $ rsync --copy-links --recursive --times --verbose rsync://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/001/039/535/GCA_001039535.1_ASM103953v1/GCA_001039535.1_ASM103953v1_genomic.fna.gz bighorn_genome/


Unzip the genome file and use `less` to visually inspect this new file. You’ll notice that the sequences have strange line endings that cause the sequences to be cut off after 60 base pairs and then go to the next line. In your directory, you’ll find a python script that you can use to remove these line endings (`remove_60.py`). The file produced by this python script will be what we use to align our sequences. You should now move your final genome file to the directory where your `fastq` files are, and rename the genome file `bighorn_genome.fa`.

## Aligning RADseq data to the reference genome

We will be using the program `bwa` to perform reference-based alignment of our sequencing data to our reference genome. Please carefully read the `bwa` [manual page](http://bio-bwa.sourceforge.net/bwa.shtml) before moving forward. Pay particular attention to the `index`, `aln`, and `samse` commands and their associated options.

To access bwa commands on Tom’s server, we will have to load the `bwa` module. You can view available program modules using:

      $ module avail

We will be using version 0.7.8. To load the `bwa` module, type:

      $ module load bwa/0.7.8

We will first use the `index` command to create an index of the sequences found in our reference genome:

      $ bwa index -p bighorn_ref -a bwtsw bighorn_genome.fa

This command will likely take a long time, so you may want to put the job in the background so you can do other things. To stop the job, type control-Z at the same time. To restart the job in the background, type:

      $ bg
      $ disown -h

You can visually monitor the progress of your job using the Unix command `top`. To exit the `top` window, simply type `q` (just like exiting a `less` window).

What files were produced from the index command? Next, we will be using a Python wrapper (`run_bwa.py`) to perform the `aln` and `samse` commands of `bwa`. Carefully inspect this wrapper and interpret what each line is doing. Pay close attention to the different options employed for each command. What input do you need to give this file for it to be able to work? Use the `run_bwa.py` script to perform the reference-based alignment. You will want to place this job in the background as well, and you can automatically do this by placing an `&` at the end of the command.

      $ module load bwa/0.7.8
      $ python3 run_bwa.py *.fastq &> bwa.out

The script will produce a `sam` and `sai` file for each individual `fastq` file. You can learn a lot about the format of SAM files at the [SAMtools documentation page](https://samtools.github.io/hts-specs/SAMv1.pdf).




